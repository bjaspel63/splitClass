// script.js

// Elements
const setupSection = document.getElementById("setup");
const mainSection = document.getElementById("main");

const btnTeacher = document.getElementById("btnTeacher");
const btnStudent = document.getElementById("btnStudent");

const nameInput = document.getElementById("studentNameInput");
const roomInput = document.getElementById("roomInput");

const displayNameEl = document.getElementById("displayName");
const displayRoomEl = document.getElementById("displayRoom");

const nameContainer = document.getElementById("nameContainer");
const roomContainer = document.getElementById("roomContainer");

const studentsListContainer = document.getElementById("studentsListContainer");
const studentsList = document.getElementById("studentsList");
const studentCountDisplay = document.getElementById("studentCountDisplay");

const videoEl = document.getElementById("video");
const notesArea = document.getElementById("notesArea");
const editorFrame = document.getElementById("editorFrame");

const teacherControls = document.getElementById("teacherControls");
const studentControls = document.getElementById("studentControls");

const btnDownloadNotes = document.getElementById("btnDownloadNotes");
const btnShareScreen = document.getElementById("btnShareScreen");
const btnCloseTeacher = document.getElementById("btnCloseSessionTeacher");
const btnCloseStudent = document.getElementById("btnCloseSessionStudent");

const leftPane = document.getElementById("leftPane");
const rightPane = document.getElementById("rightPane");

let currentRole = null;

// ===== Helper Functions =====
function showTeacherView() {
  currentRole = "teacher";

  // Layout: Teacher → Left 25%, Right 75%
  leftPane.style.width = "25%";
  rightPane.style.width = "75%";

  studentsListContainer.classList.remove("hidden");
  notesArea.classList.remove("hidden");
  videoEl.style.display = "none";
  editorFrame.classList.add("hidden");

  teacherControls.classList.remove("hidden");
  studentControls.classList.add("hidden");

  // Mock students attending
  studentsList.innerHTML = "";
  const mockStudents = ["Alice", "Bob", "Charlie"];
  mockStudents.forEach(name => {
    const li = document.createElement("li");
    li.textContent = name;
    studentsList.appendChild(li);
  });
  studentCountDisplay.textContent = mockStudents.length;
}

function showStudentView() {
  currentRole = "student";

  // Layout: Student → Left 50%, Right 50%
  leftPane.style.width = "50%";
  rightPane.style.width = "50%";

  studentsListContainer.classList.add("hidden");
  notesArea.classList.add("hidden");
  editorFrame.classList.remove("hidden");
  videoEl.style.display = "block";

  teacherControls.classList.add("hidden");
  studentControls.classList.remove("hidden");

  // Start webcam
  navigator.mediaDevices.getUserMedia({ video: true, audio: false })
    .then(stream => {
      videoEl.srcObject = stream;
    })
    .catch(err => {
      console.error("Error accessing webcam:", err);
    });
}

function resetUI() {
  currentRole = null;

  setupSection.classList.remove("hidden");
  mainSection.classList.add("hidden");
  teacherControls.classList.add("hidden");
  studentControls.classList.add("hidden");

  nameContainer.style.display = "none";
  roomContainer.style.display = "none";

  notesArea.value = "";
  studentsList.innerHTML = "";
  studentCountDisplay.textContent = "0";
}

// ===== Event Listeners =====
btnTeacher.addEventListener("click", () => {
  const name = nameInput.value.trim();
  const room = roomInput.value.trim();

  if (!name || !room) {
    alert("Please enter both name and room.");
    return;
  }

  // Display name and room
  displayNameEl.textContent = name;
  displayRoomEl.textContent = room;
  nameContainer.style.display = "flex";
  roomContainer.style.display = "flex";

  setupSection.classList.add("hidden");
  mainSection.classList.remove("hidden");

  showTeacherView();
});

btnStudent.addEventListener("click", () => {
  const name = nameInput.value.trim();
  const room = roomInput.value.trim();

  if (!name || !room) {
    alert("Please enter both name and room.");
    return;
  }

  // Display name and room
  displayNameEl.textContent = name;
  displayRoomEl.textContent = room;
  nameContainer.style.display = "flex";
  roomContainer.style.display = "flex";

  setupSection.classList.add("hidden");
  mainSection.classList.remove("hidden");

  showStudentView();
});

btnDownloadNotes.addEventListener("click", () => {
  const blob = new Blob([notesArea.value], { type: "text/plain" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "notes.txt";
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
});

btnShareScreen.addEventListener("click", async () => {
  try {
    const stream = await navigator.mediaDevices.getDisplayMedia({ video: true });
    videoEl.srcObject = stream;
    videoEl.style.display = "block";
  } catch (err) {
    console.error("Error sharing screen:", err);
  }
});

btnCloseTeacher.addEventListener("click", () => {
  resetUI();
});

btnCloseStudent.addEventListener("click", () => {
  resetUI();
});